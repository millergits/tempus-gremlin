<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gremlin CLI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&family=Inter:wght@400;600&display=swap');

        body {
            background-color: #050505;
            /* Nearly Black */
            color: #c9d1d9;
            overflow: hidden;
            font-family: 'Fira Code', monospace;
        }

        /* Terminal Scrollbar */
        .terminal-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .terminal-scroll::-webkit-scrollbar-track {
            background: #0d1117;
        }

        .terminal-scroll::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        .terminal-scroll::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }

        /* Cursor */
        .cursor {
            display: inline-block;
            width: 10px;
            height: 1.2em;
            background-color: #4ade80;
            /* Green */
            animation: blink 1s step-end infinite;
            vertical-align: text-bottom;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        /* Tables */
        .term-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        .term-table th {
            text-align: left;
            border-bottom: 1px solid #30363d;
            color: #8b949e;
            padding: 0.5rem;
        }

        .term-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #21262d;
        }

        /* Diff Colors */
        .diff-add {
            color: #4ade80;
        }

        .diff-remove {
            color: #fdaeb7;
        }

        .diff-header {
            color: #8b949e;
        }

        /* Scanline */
        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.02) 50%, rgba(0, 0, 0, 0.02));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
        }

        /* ASCII Art - Single Color */
        .gremlin-green {
            color: #4ade80;
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.3);
        }

        .ascii-art {
            font-weight: bold;
            line-height: 1.1;
        }
    </style>
</head>

<body class="h-screen w-screen flex flex-col p-4 md:p-8 selection:bg-green-500/30 justify-center items-center">

    <div class="scanline"></div>

    <!-- Terminal Window -->
    <div
        class="bg-[#0d1117] border border-[#30363d] rounded-lg shadow-2xl flex flex-col overflow-hidden relative w-full max-w-5xl h-[85vh]">

        <!-- Title Bar -->
        <div class="bg-[#010409] px-4 py-2 flex items-center justify-between border-b border-[#30363d]">
            <div class="flex space-x-2">
                <div class="w-3 h-3 rounded-full bg-[#ff5f56]"></div>
                <div class="w-3 h-3 rounded-full bg-[#ffbd2e]"></div>
                <div class="w-3 h-3 rounded-full bg-[#27c93f]"></div>
            </div>
            <div class="text-xs text-[#8b949e] font-semibold flex items-center">
                <i class="fa-solid fa-shield-halved mr-2 text-green-500"></i> scientist@tempus-cluster-01
            </div>
            <div class="w-12"></div>
        </div>

        <!-- Content -->
        <div id="terminal-output" class="flex-grow p-6 overflow-y-auto terminal-scroll text-sm md:text-base font-mono">

            <!-- Welcome Banner -->
            <div class="mb-8 animate-fade-in flex items-start space-x-6 border-b border-[#30363d] pb-6">
                <!-- GIZMO ART -->
                <pre class="gremlin-green text-[10px] md:text-[12px] leading-none block">
         ,           ,
        / \         / \
       /   \       /   \
      /     \     /     \
     (       \___/       )
      \   O         O   /
       \       ^       /
        \    _____    /
         \__/     \__/
                </pre>

                <!-- TEXT LOGO -->
                <div>
                    <pre class="ascii-art gremlin-green text-[10px] md:text-xs leading-[1.1]">
  ____ ____  _____ __  __ _     ___ _   _
 / ___|  _ \| ____|  \/  | |   |_ _| \ | |
| |  _| |_) |  _| | |\/| | |    | ||  \| |
| |_| |  _ <| |___| |  | | |___ | || |\  |
 \____|_| \_\_____|_|  |_|_____|___|_| \_|</pre>
                    <div class="text-[#8b949e] mt-3 mb-1">Tempus Gremlin CLI <span class="text-green-400">v2.4</span>
                    </div>
                    <div class="text-[#c9d1d9] text-[11px] uppercase tracking-wide font-semibold">
                        <span class="gremlin-green">G</span>ENERATIVE
                        <span class="gremlin-green">R</span>ESEARCH
                        <span class="gremlin-green">E</span>NGINE FOR
                        <span class="gremlin-green">M</span>ACHINE
                        <span class="gremlin-green">L</span>EARNING
                        <span class="gremlin-green">I</span>NFRASTRUCTURE &
                        <span class="gremlin-green">N</span>AVIGATION
                    </div>
                </div>
            </div>

            <!-- History -->
            <div id="history"></div>

            <!-- Input Line -->
            <div class="flex items-center mt-4 pb-2" id="input-line">
                <span class="text-green-400 font-bold mr-2">gremlin ></span>
                <div class="relative flex-grow">
                    <input type="text" id="terminal-input"
                        class="w-full bg-transparent border-none outline-none text-[#e6edf3] font-mono caret-transparent"
                        autocomplete="off" spellcheck="false" autofocus>
                    <div id="ghost-text"
                        class="absolute top-0 left-0 pointer-events-none text-[#e6edf3] opacity-50 whitespace-pre-wrap">
                    </div>
                </div>
                <span class="cursor"></span>
            </div>
        </div>
    </div>

    <!-- PRO TIP BADGE (Static & Centered) -->
    <div class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 pointer-events-none opacity-70">
        <div
            class="bg-[#0d1117]/90 text-[#8b949e] text-xs px-4 py-2 rounded-full border border-[#30363d] shadow-2xl backdrop-blur-md flex items-center gap-2">
            <i class="fa-solid fa-terminal text-green-500"></i>
            <span>Pro Tip: Press <span
                    class="text-green-400 font-bold font-mono bg-[#30363d] px-1.5 rounded mx-1">TAB</span> to
                auto-complete commands</span>
        </div>
    </div>

    <script>
        // --- LINEAR SCENARIO SCRIPT ---
        const endToEndScenario = [
            {
                user: "TBD: Show me available data sources for the lung cancer project.",
                ai: {
                    think: "Invoking DataTools.list_sources('lung_cancer')...",
                    response: `
                        <div class="text-[#c9d1d9] mb-2">Scanning available data sources for <span class="text-green-400">lung_cancer</span> project...</div>
                        <table class="term-table">
                            <thead><tr><th>Source</th><th>Records</th><th>Last Updated</th><th>Status</th></tr></thead>
                            <tbody>
                                <tr><td>Clinical Records</td><td>45,230</td><td>2024-12-10</td><td><span class="text-green-400">✅ Ready</span></td></tr>
                                <tr><td>Genomic Data</td><td>12,450</td><td>2024-12-08</td><td><span class="text-green-400">✅ Ready</span></td></tr>
                                <tr><td>Imaging (CT)</td><td>8,920</td><td>2024-12-05</td><td><span class="text-yellow-400">⚠️ Processing</span></td></tr>
                                <tr><td>Lab Results</td><td>156,780</td><td>2024-12-11</td><td><span class="text-green-400">✅ Ready</span></td></tr>
                            </tbody>
                        </table>
                        <div class="text-[#c9d1d9]"><strong>Action:</strong> Would you like to create a unified dataset from these sources?</div>
                    `
                }
            },
            {
                user: "TBD: Yes, create a unified dataset combining clinical and genomic data.",
                ai: {
                    think: "Invoking DataTools.create_unified_dataset()... Validating schema compatibility...",
                    response: `
                        <div class="text-green-400 mb-1">✔ Schema validation passed.</div>
                        <div class="text-[#c9d1d9] mb-2">Creating unified dataset...</div>
                        <div class="bg-[#161b22] p-3 rounded border border-[#30363d] font-mono text-xs mb-4">
                            <div class="diff-header">dataset_config:</div>
                            <div class="diff-add">+  name: "lung_cancer_unified_v1"</div>
                            <div class="diff-add">+  sources: ["clinical", "genomic"]</div>
                            <div class="diff-add">+  join_key: "patient_id"</div>
                            <div class="diff-add">+  records: 11,842 (intersection)</div>
                        </div>
                        <div class="text-[#c9d1d9]">Dataset Created: <span class="text-green-400 underline cursor-pointer">atlas://datasets/lung_cancer_unified_v1</span></div>
                        <div class="text-[#8b949e] text-xs">Pinned to sha256:c4d8f1...</div>
                    `
                }
            },
            {
                user: "TBD: Run data quality checks on the new dataset.",
                ai: {
                    think: "Invoking DataQuality.run_checks('lung_cancer_unified_v1')...",
                    response: `
                        <div class="text-[#c9d1d9] mb-2">Running comprehensive data quality checks...</div>
                        <table class="term-table">
                            <thead><tr><th>Check</th><th>Result</th><th>Details</th></tr></thead>
                            <tbody>
                                <tr><td>Missing Values</td><td><span class="text-green-400">✅ Pass</span></td><td>< 2% missing across all columns</td></tr>
                                <tr><td>Duplicate Records</td><td><span class="text-green-400">✅ Pass</span></td><td>0 duplicates found</td></tr>
                                <tr><td>Schema Validation</td><td><span class="text-green-400">✅ Pass</span></td><td>All types match expected</td></tr>
                                <tr><td>Outlier Detection</td><td><span class="text-yellow-400">⚠️ Warning</span></td><td>12 records flagged for review</td></tr>
                            </tbody>
                        </table>
                        <div class="text-[#c9d1d9]">Overall: <span class="text-green-400">Dataset is ready for analysis</span></div>
                    `
                }
            },
            {
                user: "TBD: Show me the flagged outlier records.",
                ai: {
                    think: "Invoking DataQuality.get_outliers('lung_cancer_unified_v1')...",
                    response: `
                        <div class="text-[#c9d1d9] mb-2">Displaying 12 flagged records:</div>
                        <table class="term-table" style="width: 80%">
                            <thead><tr><th>Patient ID</th><th>Issue</th><th>Field</th><th>Value</th></tr></thead>
                            <tbody>
                                <tr><td>PT-4521</td><td>Age > 120</td><td>age_at_diagnosis</td><td>145</td></tr>
                                <tr><td>PT-7832</td><td>Negative value</td><td>tumor_size_mm</td><td>-2.5</td></tr>
                                <tr><td>PT-9012</td><td>Future date</td><td>diagnosis_date</td><td>2025-03-15</td></tr>
                                <tr><td colspan="4" class="text-[#8b949e]">... 9 more records</td></tr>
                            </tbody>
                        </table>
                        <div class="text-[#c9d1d9]"><strong>Action:</strong> Exclude these records from the dataset?</div>
                    `
                }
            },
            {
                user: "TBD: Yes, exclude them and create a cleaned version.",
                ai: {
                    think: "Invoking DataTools.filter_records()... Creating cleaned dataset...",
                    response: `
                        <div class="text-green-400 mb-1">✔ 12 records excluded.</div>
                        <div class="text-[#c9d1d9]">Cleaned Dataset: <span class="text-green-400 underline cursor-pointer">atlas://datasets/lung_cancer_unified_v1_clean</span></div>
                        <div class="text-[#c9d1d9] mt-2">Final record count: <strong class="text-white">11,830</strong></div>
                        <div class="text-[#8b949e] text-xs mt-2">Lineage tracked: lung_cancer_unified_v1 → lung_cancer_unified_v1_clean</div>
                    `
                }
            }
        ];

        // --- ENGINE ---
        const state = { step: 0, isTyping: false, isThinking: false, typedText: "" };
        const elements = {
            history: document.getElementById('history'),
            input: document.getElementById('terminal-input'),
            ghost: document.getElementById('ghost-text'),
            output: document.getElementById('terminal-output')
        };

        function startScenario() {
            state.step = 0;
            elements.history.innerHTML = '';
            // Add start divider
            const div = document.createElement('div');
            div.className = "my-4 border-t border-dashed border-slate-700 pt-2 text-center text-xs text-slate-600";
            div.innerText = `--- NEW SESSION: DATA PIPELINE DEMO ---`;
            elements.history.appendChild(div);
            prepareStep();
        }

        function prepareStep() {
            if (state.step >= endToEndScenario.length) {
                state.targetText = "";
                elements.input.value = "";
                elements.ghost.textContent = "";

                // End of Demo Message
                const endDiv = document.createElement('div');
                endDiv.className = "mt-8 text-center text-[#8b949e] text-xs animate-pulse";
                endDiv.innerText = "[ END OF DEMO SCENARIO ]";
                elements.history.appendChild(endDiv);
                scrollToBottom();
                return;
            }
            state.targetText = endToEndScenario[state.step].user;
            state.typedText = "";
            elements.input.value = "";
            elements.ghost.textContent = "";
            elements.input.focus();
            scrollToBottom();
        }

        function scrollToBottom() {
            elements.output.scrollTop = elements.output.scrollHeight;
            requestAnimationFrame(() => {
                elements.output.scrollTop = elements.output.scrollHeight;
            });
        }

        function addEntry(type, content) {
            const div = document.createElement('div');
            div.className = "mb-6 animate-fade-in";

            if (type === 'user') {
                div.innerHTML = `
                    <div class="flex items-start">
                        <span class="text-green-400 font-bold mr-2 mt-0.5">❯</span>
                        <div class="text-[#e6edf3] font-semibold">${content}</div>
                    </div>
                `;
            } else if (type === 'ai') {
                div.innerHTML = `
                    <div class="flex items-start mt-2">
                        <div class="text-purple-400 font-bold mr-3 mt-0.5 text-xs">GREMLIN</div>
                        <div class="flex-grow text-[#c9d1d9] leading-relaxed text-sm">${content}</div>
                    </div>
                `;
            } else if (type === 'think') {
                div.id = "thinking";
                div.innerHTML = `
                    <div class="flex items-center text-slate-500 text-xs ml-9 animate-pulse font-mono">
                        <i class="fa-solid fa-microchip mr-2"></i> ${content}
                    </div>
                `;
            }
            elements.history.appendChild(div);
            scrollToBottom();
            return div;
        }

        function submit() {
            if (state.step >= endToEndScenario.length) return;

            const text = elements.input.value;
            if (!text.trim()) return;

            addEntry('user', text);
            elements.input.value = "";
            elements.ghost.textContent = "";
            state.typedText = "";

            state.isThinking = true;
            const scenario = endToEndScenario[state.step];
            const thinkEl = addEntry('think', scenario.ai.think);

            setTimeout(() => {
                // Transform Thinking into a Persistent Log Entry
                thinkEl.innerHTML = `
                    <div class="flex items-center text-slate-600 text-xs ml-9 font-mono">
                        <span class="text-green-500 mr-2">[LOG]</span> ${scenario.ai.think.replace('...', '')} ... <span class="text-green-500 ml-1">DONE</span>
                    </div>
                `;
                thinkEl.id = ""; // Stop being the "active" thinking element
                thinkEl.classList.remove("animate-pulse"); // Stop pulsing

                // Add the actual AI response
                addEntry('ai', scenario.ai.response);

                state.isThinking = false;
                state.step++;

                // Notify parent to sync walkthrough scroll (step is 1-indexed for display)
                window.parent.postMessage({ type: 'cliStepComplete', step: state.step }, '*');

                prepareStep();
            }, 1200);
        }

        // Magic Typing Handler
        elements.input.addEventListener('keydown', (e) => {
            if (state.isThinking || state.step >= endToEndScenario.length) {
                e.preventDefault();
                return;
            }

            // Tab Autocomplete
            if (e.key === 'Tab') {
                e.preventDefault();
                if (state.typedText.length < state.targetText.length) {
                    state.typedText = state.targetText;
                    elements.input.value = state.typedText;
                    elements.ghost.textContent = state.typedText;
                    scrollToBottom();
                }
                return;
            }

            if (e.key === 'Enter') {
                // Ensure text is filled before submitting
                state.typedText = state.targetText;
                elements.input.value = state.typedText;
                elements.ghost.textContent = state.typedText;

                // Submit immediately
                submit();
                e.preventDefault();
            } else if (e.key === 'Backspace') {
                state.typedText = state.typedText.slice(0, -1);
                e.preventDefault();
            } else if (!e.ctrlKey && !e.metaKey && !e.altKey && e.key.length === 1) {
                e.preventDefault();
                const nextChar = state.targetText[state.typedText.length];
                if (nextChar) state.typedText += nextChar;
            }

            elements.input.value = state.typedText;
            elements.ghost.textContent = state.typedText;
            scrollToBottom();
        });

        // Focus Handling
        document.getElementById('terminal-output').addEventListener('click', () => elements.input.focus());

        // Listen for reset message from parent
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'resetWorkflow') {
                startScenario();
            }
        });

        // Init
        startScenario();

        function scrollToBottom() {
            elements.output.scrollTop = elements.output.scrollHeight;
            requestAnimationFrame(() => {
                elements.output.scrollTop = elements.output.scrollHeight;
            });
        }

    </script>
</body>

</html>